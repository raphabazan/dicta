<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recording Widget</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 155px;
      height: 120px;
      overflow: hidden; /* Remove scrollbars */
      background: transparent;
      font-family: system-ui, -apple-system, sans-serif;
    }

    /* Force hide any scrollbars */
    body::-webkit-scrollbar {
      display: none;
    }
    body {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }

    .widget {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 155px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: space-evenly;
      background: rgba(17, 24, 39, 0.95);
      border: 1px solid rgba(239, 68, 68, 0.5);
      border-radius: 20px;
      padding: 0 6px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      cursor: move;
      user-select: none;
    }

    .drag-area {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: move;
    }

    .indicator {
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .btn {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
      padding: 0;
    }

    .btn:hover {
      transform: scale(1.1);
    }

    .btn-cancel {
      background: transparent;
    }

    .btn-cancel:hover {
      background: rgba(107, 114, 128, 0.5);
    }

    .btn-tts {
      background: transparent;
      position: relative;
    }

    .btn-tts:hover {
      background: rgba(107, 114, 128, 0.3);
    }

    .btn-tts svg {
      width: 16px;
      height: 16px;
    }

    .btn-tts .tts-slash {
      display: none;
    }

    .btn-tts.tts-off .tts-slash {
      display: block;
    }

    .btn-tts.tts-off .tts-waves {
      display: none;
    }

    .btn-stop {
      background: #ef4444;
    }

    .btn-stop:hover {
      background: #dc2626;
    }

    .icon-cancel {
      width: 12px;
      height: 12px;
    }

    .icon-stop {
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 2px;
    }

    /* Model selector combo box */
    .model-selector {
      position: absolute;
      top: -110px;
      left: 0;
      width: 155px;
      background: rgba(17, 24, 39, 0.95);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      padding: 4px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      backdrop-filter: blur(8px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
      z-index: 10;
    }

    .widget:hover .model-selector,
    .widget.force-hover .model-selector {
      opacity: 1;
      visibility: visible;
    }

    .model-option {
      width: 100%;
      padding: 6px 8px;
      background: transparent;
      border: none;
      color: white;
      font-size: 11px;
      text-align: left;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.15s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .model-option:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    .model-option.active {
      background: rgba(239, 68, 68, 0.3);
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="widget" id="widget">
    <!-- Model selector (appears on hover) -->
    <div class="model-selector" id="modelSelector">
      <button class="model-option" data-model="transcribe-only" title="Transcribe Only">
        Transcribe Only
      </button>
      <button class="model-option" data-model="gpt-4o-mini" title="GPT-4o Mini">
        GPT-4o-mini
      </button>
      <button class="model-option" data-model="gpt-4.1" title="GPT-4.1">
        GPT-4.1
      </button>
    </div>

    <button class="btn btn-cancel" id="cancelBtn" title="Cancel">
      <svg class="icon-cancel" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M1 1L11 11M1 11L11 1" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
    </button>
    <div class="drag-area" id="dragArea" data-tauri-drag-region>
      <div class="indicator"></div>
    </div>
    <button class="btn btn-tts tts-off" id="ttsBtn" title="Toggle TTS">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M11 5L6 9H2v6h4l5 4V5z" fill="rgba(56, 189, 248, 0.9)"/>
        <path class="tts-waves" d="M15.54 8.46a5 5 0 010 7.07" stroke="rgba(56, 189, 248, 0.9)" stroke-width="1.5" stroke-linecap="round"/>
        <path class="tts-slash" d="M3 21L21 3" stroke="#ef4444" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
    <button class="btn btn-stop" id="stopBtn" title="Stop & Send">
      <div class="icon-stop"></div>
    </button>
  </div>

  <script type="module">
    import { invoke } from '@tauri-apps/api/core';
    import { emit, listen } from '@tauri-apps/api/event';
    import { getCurrentWebviewWindow } from '@tauri-apps/api/webviewWindow';

    const cancelBtn = document.getElementById('cancelBtn');
    const stopBtn = document.getElementById('stopBtn');
    const ttsBtn = document.getElementById('ttsBtn');
    const dragArea = document.getElementById('dragArea');
    const widget = document.getElementById('widget');
    const currentWindow = getCurrentWebviewWindow();
    const modelOptions = document.querySelectorAll('.model-option');

    // TTS state
    let ttsEnabled = false;

    function updateTtsIcon(enabled) {
      ttsEnabled = enabled;
      if (enabled) {
        ttsBtn.classList.remove('tts-off');
        ttsBtn.title = 'TTS ON (click to disable)';
      } else {
        ttsBtn.classList.add('tts-off');
        ttsBtn.title = 'TTS OFF (click to enable)';
      }
    }

    // Load TTS state on start
    invoke('get_tts_enabled').then(val => updateTtsIcon(val)).catch(() => {});

    // Listen for TTS toggle events (from Ctrl+Alt+S or other sources)
    listen('tts-toggled', (event) => {
      updateTtsIcon(event.payload);
    });

    // TTS toggle on click
    ttsBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      try {
        const newVal = !ttsEnabled;
        await invoke('set_tts_enabled', { enabled: newVal });
        updateTtsIcon(newVal);
      } catch (error) {
        console.error('Failed to toggle TTS:', error);
      }
    });

    // Load and set active model from database
    async function loadSelectedModel() {
      try {
        const model = await invoke('get_selected_prompt_model') || 'transcribe-only';
        console.log('Loading model from database:', model);
        modelOptions.forEach(opt => {
          opt.classList.toggle('active', opt.dataset.model === model);
        });
      } catch (error) {
        console.error('Failed to load model:', error);
      }
    }

    // Force hover display for 2 seconds when widget becomes visible
    let forceHoverTimeout = null;

    function showForceHover() {
      loadSelectedModel();
      widget.classList.add('force-hover');
      if (forceHoverTimeout) clearTimeout(forceHoverTimeout);
      forceHoverTimeout = setTimeout(() => {
        widget.classList.remove('force-hover');
      }, 2000);
    }

    // Trigger on window focus (when Tauri calls window.show())
    window.addEventListener('focus', () => {
      showForceHover();
    });

    // Also trigger on visibilitychange
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        showForceHover();
      }
    });

    // Model selection
    modelOptions.forEach(option => {
      option.addEventListener('click', async (e) => {
        e.stopPropagation(); // Prevent dragging
        const model = option.dataset.model;
        try {
          await invoke('set_selected_prompt_model', { model, saveAsDefault: true });
          modelOptions.forEach(opt => opt.classList.remove('active'));
          option.classList.add('active');
        } catch (error) {
          console.error('Failed to save model:', error);
        }
      });
    });

    // Load selected model on start
    loadSelectedModel();

    // Listen for model-selected event from backend (sent when recording starts)
    listen('model-selected', (event) => {
      const model = event.payload;
      modelOptions.forEach(opt => {
        opt.classList.toggle('active', opt.dataset.model === model);
      });
      showForceHover();
    });

    cancelBtn.addEventListener('click', async () => {
      try {
        await invoke('cancel_recording');
        await emit('recording-cancelled');
        await currentWindow.hide();
      } catch (error) {
        console.error('Failed to cancel:', error);
      }
    });

    stopBtn.addEventListener('click', async () => {
      try {
        await emit('widget-stop-recording');
        await currentWindow.hide();
      } catch (error) {
        console.error('Failed to stop:', error);
      }
    });
  </script>
</body>
</html>
